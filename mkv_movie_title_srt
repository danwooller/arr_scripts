#!/bin/bash

# A script to check and update the "Title" field in an MKV file
# using mkvinfo and mkvpropedit. The desired title is set to match
# the name of the immediate containing folder.

# --- Configuration ---
# Set the MKV extension to check for
MKV_EXTENSION=".mkv"

# Set the default directory to scan if no files are provided as arguments
# This default is used if the user doesn't specify a directory or files.
DEFAULT_TARGET_DIR="/mnt/media/Movies"

# --- Helper Function ---

# Function to process a single MKV file
process_mkv() {
    local file="$1"
    
    # 1. Check if the file exists and is a regular file
    if [[ ! -f "$file" ]]; then
        echo "Skipping: $file is not a regular file."
        return 1
    fi

    echo "--- Processing: $file ---"

    # 2. Determine the desired title (the name of the containing folder)
    # We first get the path of the parent directory, then extract its base name.
    local file_dir=$(dirname "$file")
    local desired_title=$(basename "$file_dir")

    # 3. Read the current "Title" property from the MKV file
    # We use mkvinfo and grep, focusing on the global document title.
    # The 'sed' command strips everything before "Title: "
    local current_title=$(mkvinfo "$file" 2>/dev/null | grep -m 1 "Title:" | sed 's/^.*Title: //; s/^ *//; s/ *$//')

    # If the current_title is empty (meaning no title is set), use an empty string for comparison
    if [[ -z "$current_title" ]]; then
        current_title=""
        echo "Current Title: <None Set>"
    else
        echo "Current Title: \"$current_title\""
    fi

    echo "Desired Title: \"$desired_title\""

    # 4. Compare and Update
    if [[ "$current_title" == "$desired_title" ]]; then
        echo "Status: Title already matches the folder name. No action required."
    else
        echo "Action: Updating Title field..."
        # Use mkvpropedit to set the segment title
        mkvpropedit "$file" --edit info --set "title=$desired_title"

        if [ $? -eq 0 ]; then
            echo "SUCCESS: Title updated to \"$desired_title\""
        else
            echo "ERROR: Failed to update title using mkvpropedit."
            return 1
        fi
    fi
    echo "" # Newline for separation
}

# --- Main Script Logic ---

# Check dependencies
if ! command -v mkvpropedit &> /dev/null || ! command -v mkvinfo &> /dev/null; then
    echo "Error: 'mkvpropedit' or 'mkvinfo' (part of mkvtoolnix) is not installed." >&2
    echo "Please install mkvtoolnix to run this script." >&2
    exit 1
fi

# Determine files to process
files_to_process=()
TARGET_DIR="$DEFAULT_TARGET_DIR"

if [ "$#" -gt 0 ]; then
    # Check if the first argument is a directory
    if [[ -d "$1" ]]; then
        # If $1 is a directory, use it as the new TARGET_DIR for a recursive search
        TARGET_DIR="$1"
        echo "Directory provided as argument. Searching recursively for *.mkv in $TARGET_DIR..."

        # Use find -print0 for robust, recursive searching.
        while IFS= read -r -d $'\0' file; do
            files_to_process+=("$file")
        done < <(find "$TARGET_DIR" -type f -name "*${MKV_EXTENSION}" -print0)

    else
        # If arguments are provided but $1 is NOT a directory, assume arguments are specific files
        echo "Arguments provided are not a directory. Processing specific files..."
        files_to_process=("$@")
    fi
else
    # If no arguments are provided, process the default directory recursively
    echo "No files specified. Searching recursively for *.mkv in $TARGET_DIR..."

    if [[ ! -d "$TARGET_DIR" ]]; then
        echo "Error: Default target directory '$TARGET_DIR' does not exist or is not a directory." >&2
        exit 1
    fi
    
    # Use find -print0 for robust, recursive searching.
    while IFS= read -r -d $'\0' file; do
        files_to_process+=("$file")
    done < <(find "$TARGET_DIR" -type f -name "*${MKV_EXTENSION}" -print0)
fi


# Process the identified files
if [ ${#files_to_process[@]} -eq 0 ]; then
    echo "No ${MKV_EXTENSION} files found to process in the specified location: $TARGET_DIR"
    exit 0
fi

echo "Found ${#files_to_process[@]} file(s) to check."
echo ""

for mkv_file in "${files_to_process[@]}"; do
    process_mkv "$mkv_file"
done

echo "Script finished."
