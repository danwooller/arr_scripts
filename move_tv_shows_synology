#!/bin/bash

# === Configuration ===

# The directory to check *against*.
# We will look for matches to the folder names found here.
# This is also the FINAL destination.
SYNOLOGY_DIR="/mnt/synology/TV"

# The directory to move folders *from*.
MEDIA_DIR="/mnt/media/TV"

# Set to "true" for a dry run. No files will be moved.
# Set to "false" to perform the actual move.
DRY_RUN=false
#DRY_RUN=true

# === End of Configuration ===


# --- Safety Checks ---
if [ ! -d "$SYNOLOGY_DIR" ]; then
    echo "Error: Synology directory not found: $SYNOLOGY_DIR"
    echo "Please check the path and permissions."
    exit 1
fi

if [ ! -d "$MEDIA_DIR" ]; then
    echo "Error: Media directory not found: $MEDIA_DIR"
    echo "Please check the path and permissions."
    exit 1
fi

echo "Starting TV show sync..."
echo "Reference (and Destination): $SYNOLOGY_DIR"
echo "Source (Move From):         $MEDIA_DIR"
echo "---"

if $DRY_RUN; then
    echo "DRY RUN ENABLED. No files will be moved."
    RSYNC_OPTS="-avhn --progress --stats"
else
    echo "PRODUCTION RUN. Files will be moved."
    # -a: archive mode (recursive, preserves permissions, etc.)
    # -v: verbose
    # -h: human-readable
    # --remove-source-files: This is what makes it a "move" operation.
    # --progress: Shows file transfer progress.
    RSYNC_OPTS="-avh --remove-source-files --progress"
fi
echo "---"


# Loop through each directory in the SYNOLOGY_DIR
# The */ at the end of the path ensures we only match directories
for dest_show_path in "$SYNOLOGY_DIR"/*/; do

    # Check if the path is a valid directory (handles empty dirs)
    if [ -d "$dest_show_path" ]; then
    
        # Get just the folder name, e.g. "/mnt/synology/TV/Show Name/" -> "Show Name"
        show_name=$(basename "$dest_show_path")
        
        # Construct the full path to the matching source folder
        source_show_path="$MEDIA_DIR/$show_name"
        
        # Check if that matching folder exists in the MEDIA_DIR
        if [ -d "$source_show_path" ]; then
            echo "Match found: '$show_name'"
            echo "Syncing from: '$source_show_path/'"
            echo "Syncing to:   '$dest_show_path/'"
            
            # --- The Move Operation ---
            # We use rsync to "move-and-merge" the contents.
            # The trailing slash on the source path ($source_show_path/) is critical.
            # It tells rsync to move the *contents* of the folder,
            # not the folder itself, which prevents nesting.
            rsync $RSYNC_OPTS "$source_show_path/" "$dest_show_path/"
            
            # --- Cleanup ---
            # If the move was successful (and not a dry run),
            # the source dir might be empty. If so, remove it.
            if ! $DRY_RUN; then

		echo "Cleaning up empty sub-directories in '$source_show_path'..."
                # Find all empty directories (-type d -empty) starting from 
                # one level down (-mindepth 1) and delete them.
                find "$source_show_path" -mindepth 1 -type d -empty -delete

                if [ -d "$source_show_path" ] && [ -z "$(ls -A "$source_show_path")" ]; then
                    echo "Removing empty source directory: $source_show_path"
                    rmdir "$source_show_path"
                else
                    echo "Source directory '$source_show_path' not empty, skipping removal."
                fi
            fi
            
            echo "---"
        else
            # Uncomment this line if you want to see which shows were checked but not found
            # echo "No match in $MEDIA_DIR for: '$show_name'"
            : # This is a 'no-op' command to prevent a syntax error
        fi
    fi
done

echo "Script finished."
